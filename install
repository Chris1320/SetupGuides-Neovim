#!/usr/bin/env bash

# This script has been tested on the following systems:
# - GNU bash v5.1.16 on Arch Linux
# - GNU bash v5.1.16 on Linux Mint 21
# - GNU bash v5.2.15(1)-release on Kali Linux Rolling
# - GNU bash v5.2.2 on Termux Terminal Emulator 0.118.0

set -euo pipefail

# ============================================================================
# Configuration
# ============================================================================

readonly NAME="SetupGuides-Neovim"
readonly VERSION=(0 14 0)
readonly TITLE=$(printf "%s v%s.%s.%s" "${NAME}" "${VERSION[@]}")

readonly TARGET_BRANCH="main"
readonly INSTALLATION_FILES="${PWD}/src"
readonly NVIM_CONFIG_PATH="${HOME}/.config/nvim"
readonly FILELIST="files.txt"
readonly MIN_NVIM_VERSION=(0 11 2)

readonly EXIT_CODE_GIT_MISSING=1
readonly EXIT_CODE_COMPILER_MISSING=2
readonly EXIT_CODE_DOWNLOAD_FAILED=3
readonly EXIT_CODE_NPM_MISSING=4
readonly EXIT_CODE_NVIM_MISSING=5
readonly EXIT_CODE_NVIM_VERSION=6
readonly EXIT_CODE_USER_CANCELLED=7
readonly EXIT_CODE_COPY_FAILED=10
readonly EXIT_CODE_MAKE_MISSING=11

# ============================================================================
# Utility Functions
# ============================================================================

log_info() {
    printf "%s\n" "$*"
}

log_error() {
    printf "%s\n" "$*" >&2
}

log_inline() {
    printf "%s\r" "$*"
}

log_inline_done() {
    printf "%s... Done!\n" "$*"
}

log_inline_failed() {
    printf "%s... Failed!\n" "$*"
}

command_exists() {
    command -v "$1" &>/dev/null
}

version_to_string() {
    local -n arr=$1
    printf "v%s.%s.%s" "${arr[@]}"
}

version_gte() {
    local min_version="$1"
    local current_version="$2"
    local oldest=$(printf "%s\n%s" "$min_version" "$current_version" | sort -V | head -n1)
    [[ "$oldest" == "$min_version" ]]
}

prompt_yes_no() {
    local prompt="$1"
    local response

    while true; do
        printf "%s (Y/n) > " "$prompt"
        read -r response

        case "$response" in
        "" | [yY]*)
            return 0
            ;;
        [nN]*)
            return 1
            ;;
        *)
            log_info "Unknown answer."
            log_info ""
            ;;
        esac
    done
}

# ============================================================================
# Dependency Checking Functions
# ============================================================================

check_command_with_message() {
    local cmd="$1"
    local label="$2"
    local exit_code="$3"
    local install_help="$4"

    if ! command_exists "$cmd"; then
        log_error "$(printf "%-10s: not found" "$label")"
        log_error ""
        log_error "$install_help"
        exit "$exit_code"
    fi

    log_info "$(printf "%-10s: %s" "$label" "$(command -v "$cmd")")"
}

check_git() {
    check_command_with_message \
        "git" \
        "Git" \
        "$EXIT_CODE_GIT_MISSING" \
        "\`git\` is not installed. Please install git and try again.

- \`sudo apt update && sudo apt install git\`
- https://git-scm.com/downloads"
}

check_compiler() {
    if ! command_exists gcc && ! command_exists clang; then
        log_error "$(printf "%-10s: not found" "C compiler")"
        log_error ""
        log_error "\`gcc\` or \`clang\` is not installed."
        log_error "Please install either of the two and try again."
        log_error ""
        log_error "- \`sudo apt update && sudo apt install gcc\`"
        exit "$EXIT_CODE_COMPILER_MISSING"
    fi

    if command_exists gcc; then
        log_info "$(printf "%-10s: %s" "C compiler" "$(command -v gcc)")"
    else
        log_info "$(printf "%-10s: %s" "C compiler" "$(command -v clang)")"
    fi
}

check_make() {
    check_command_with_message \
        "make" \
        "make" \
        "$EXIT_CODE_MAKE_MISSING" \
        "\`make\` is not installed. Please install it and try again.

- \`sudo apt update && sudo apt install make\`"
}

check_npm() {
    check_command_with_message \
        "npm" \
        "npm" \
        "$EXIT_CODE_NPM_MISSING" \
        "\`npm\` is not installed. Please install it and try again.

- \`sudo apt update && sudo apt install nodejs npm\`
- https://nodejs.org/en/download/"
}

check_neovim() {
    log_info ""

    if ! command_exists nvim; then
        log_error "\`nvim\` is not installed. Please install nvim and try again."
        log_error ""
        log_error "- \`sudo apt update && sudo apt install neovim\`"
        log_error "- https://github.com/neovim/neovim/releases/latest"
        exit "$EXIT_CODE_NVIM_MISSING"
    fi

    log_info "Neovim is installed. Checking its version..."

    local nvim_version
    nvim_version=$(nvim -v | grep -oP 'v\d+\.\d+\.\d+' | head -n1)

    local min_version_str
    min_version_str=$(version_to_string MIN_NVIM_VERSION)

    log_info "Detected Neovim version: ${nvim_version}"

    if ! version_gte "$min_version_str" "$nvim_version"; then
        log_error "Neovim ${nvim_version} is not supported."
        log_error "Please upgrade to at least ${min_version_str} or higher and try again."
        exit "$EXIT_CODE_NVIM_VERSION"
    fi

    log_info "User's Neovim version is supported. (Requires: >= ${min_version_str})"
}

check_all_dependencies() {
    log_info "Checking requirements..."
    check_git
    check_compiler
    check_make
    check_npm
    check_neovim
}

# ============================================================================
# Installation Functions
# ============================================================================

confirm_installation() {
    log_info ""
    log_info "This will install ${NAME} on \`${NVIM_CONFIG_PATH}\`."
    log_info "This will overwrite existing files in the said directory."
    log_info ""

    if ! prompt_yes_no "Are you sure?"; then
        log_info "Cancelling installation."
        exit "$EXIT_CODE_USER_CANCELLED"
    fi

    log_info "Installing ${TITLE} customization files..."
    log_info ""
}

remove_existing_config() {
    if [[ -e "${NVIM_CONFIG_PATH}" ]]; then
        log_inline "Removing existing files in \`${NVIM_CONFIG_PATH}\`..."
        rm -rf -- "${NVIM_CONFIG_PATH}"
        log_inline_done "Removing existing files in \`${NVIM_CONFIG_PATH}\`"
    else
        log_info "No existing files found in \`${NVIM_CONFIG_PATH}\`."
    fi
}

install_from_local() {
    log_inline "Copying customization files to \`${NVIM_CONFIG_PATH}\`..."

    if cp -r "$INSTALLATION_FILES" "$NVIM_CONFIG_PATH"; then
        log_inline_done "Copying customization files to \`${NVIM_CONFIG_PATH}\`"
        return 0
    else
        log_inline_failed "Copying customization files to \`${NVIM_CONFIG_PATH}\`"
        return 1
    fi
}

install_from_remote() {
    local filelist_url="https://raw.githubusercontent.com/SetupGuides/Neovim/${TARGET_BRANCH}/${FILELIST}"

    log_info "Downloading file list..."

    local files_to_download
    files_to_download=$(curl -sSfL "${filelist_url}")

    log_inline "Downloading customization files to \`${NVIM_CONFIG_PATH}\`..."

    local file pull_url output_filepath
    for file in ${files_to_download}; do
        pull_url="${file//<branch>/${TARGET_BRANCH}}"
        output_filepath="${file##*/src/}"

        if ! curl -sSfL "${pull_url}" --create-dirs --output "${NVIM_CONFIG_PATH}/${output_filepath}"; then
            log_inline_failed "Downloading customization files to \`${NVIM_CONFIG_PATH}\`"
            return 1
        fi
    done

    log_inline_done "Downloading customization files to \`${NVIM_CONFIG_PATH}\`"
    return 0
}

perform_installation() {
    remove_existing_config

    if [[ -d "$INSTALLATION_FILES" ]]; then
        if install_from_local; then
            return 0
        else
            return "$EXIT_CODE_COPY_FAILED"
        fi
    else
        if install_from_remote; then
            return 0
        else
            return "$EXIT_CODE_DOWNLOAD_FAILED"
        fi
    fi
}

show_completion_message() {
    log_info "Please run \`nvim\` to finish the installation."
}

# ============================================================================
# Main Entry Point
# ============================================================================

main() {
    log_info ""
    log_info "$TITLE"
    log_info ""

    check_all_dependencies
    confirm_installation
    perform_installation
    show_completion_message
}

main
